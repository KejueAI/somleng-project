# Somleng Reverse Proxy Configuration
#
# DNS Requirements (production):
#   A record:  <DOMAIN>      → <server-public-ip>
#   A record:  *.<DOMAIN>    → <server-public-ip>
#
# Subdomain routing:
#   apisip.<DOMAIN>                    → Twilio-compatible REST API
#   appsip.<DOMAIN>                    → Main dashboard
#   <carrier>.appsip.<DOMAIN>          → Carrier dashboards
#   verifysip.<DOMAIN>                 → Verify API

# On-demand TLS: obtains certificates for any subdomain depth
{
	on_demand_tls {
		ask http://somleng:3000/health_checks
	}
}

# Shared reverse proxy config
(proxy) {
	handle /cable* {
		reverse_proxy ws:8080
	}

	handle {
		reverse_proxy somleng:3000 {
			header_up Host {http.request.host}
		}
	}
}

# Internal healthcheck endpoint (self-signed cert)
localhost {
	tls internal
	import proxy
}

# All other domains — on-demand TLS handles any subdomain depth
# including multi-level like my-carrier.appsip.chorus-ai.co
https:// {
	tls {
		on_demand
	}
	import proxy
}
